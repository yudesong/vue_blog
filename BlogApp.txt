<template>
  <div class="min-h-screen bg-gray-50 flex flex-col">
    <!-- 导航栏 -->
    <header class="bg-white shadow-sm sticky top-0 z-10 transition-all duration-300" :class="{ 'shadow-md': isScrolled }">
      <div class="container mx-auto px-4 py-4 flex justify-between items-center">
        <div class="flex items-center space-x-2">
          <i class="fa fa-book text-indigo-600 text-2xl"></i>
          <h1 class="text-xl font-bold text-gray-800">MyBlog</h1>
        </div>
        
        <!-- 搜索框 -->
        <div class="hidden md:flex relative flex-1 max-w-md mx-8">
          <input 
            v-model="searchQuery"
            @keyup.enter="searchArticles"
            type="text" 
            placeholder="搜索文章..." 
            class="w-full py-2 pl-10 pr-4 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"
          >
          <i class="fa fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
        </div>
        
        <nav class="flex items-center space-x-6">
          <button 
            @click="isCreateModalOpen = true"
            class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md transition-colors hidden md:block"
          >
            <i class="fa fa-pencil mr-2"></i>发布文章
          </button>
          <button class="md:hidden text-gray-700 hover:text-indigo-600 transition-colors">
            <i class="fa fa-search text-xl"></i>
          </button>
          <button class="md:hidden text-gray-700 hover:text-indigo-600 transition-colors">
            <i class="fa fa-user text-xl"></i>
          </button>
          <div class="hidden md:flex items-center space-x-2">
            <img src="https://picsum.photos/id/64/40/40" alt="用户头像" class="w-8 h-8 rounded-full object-cover">
            <span class="text-gray-700">用户名</span>
          </div>
        </nav>
      </div>
      
      <!-- 移动端搜索框 -->
      <div class="md:hidden px-4 pb-4">
        <input 
          v-model="searchQuery"
          @keyup.enter="searchArticles"
          type="text" 
          placeholder="搜索文章..." 
          class="w-full py-2 pl-10 pr-4 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 relative"
        >
        <i class="fa fa-search absolute left-7 top-[6.8rem] transform -translate-y-1/2 text-gray-400 md:hidden"></i>
      </div>
    </header>

    <!-- 主内容区 -->
    <main class="flex-grow container mx-auto px-4 py-8">
      <div class="flex flex-col md:flex-row gap-8">
        <!-- 文章列表 -->
        <div class="md:w-2/3">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">最新文章</h2>
          
          <!-- 文章列表 -->
          <div class="space-y-6">
            <div 
              v-for="article in articles" 
              :key="article.id"
              class="bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-shadow duration-300 transform hover:-translate-y-1"
            >
              <div class="p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-2 hover:text-indigo-600 transition-colors cursor-pointer"
                    @click="viewArticle(article.id)">
                  {{ article.title }}
                </h3>
                <div class="flex items-center text-gray-500 text-sm mb-4">
                  <span><i class="fa fa-user mr-1"></i> {{ article.author }}</span>
                  <span class="mx-2">•</span>
                  <span><i class="fa fa-calendar mr-1"></i> {{ formatDate(article.created_at) }}</span>
                  <span class="mx-2">•</span>
                  <span><i class="fa fa-comment-o mr-1"></i> {{ article.commentsCount || 0 }} 评论</span>
                </div>
                <p class="text-gray-600 mb-4 line-clamp-3" @click="viewArticle(article.id)">
                  {{ article.content.substring(0, 150) }}...
                </p>
                <button 
                  @click="viewArticle(article.id)"
                  class="text-indigo-600 hover:text-indigo-800 font-medium flex items-center transition-colors"
                >
                  阅读全文 <i class="fa fa-arrow-right ml-1"></i>
                </button>
              </div>
            </div>
          </div>
          
          <!-- 无文章时显示 -->
          <div v-if="articles.length === 0 && !loading" class="text-center py-12 bg-white rounded-xl shadow-sm">
            <i class="fa fa-file-text-o text-gray-300 text-5xl mb-4"></i>
            <p class="text-gray-500">没有找到相关文章</p>
            <button 
              @click="clearSearch()"
              class="mt-4 text-indigo-600 hover:text-indigo-800 font-medium"
            >
              查看所有文章
            </button>
          </div>
          
          <!-- 加载中 -->
          <div v-if="loading" class="text-center py-12 bg-white rounded-xl shadow-sm">
            <i class="fa fa-spinner fa-spin text-indigo-600 text-3xl"></i>
            <p class="mt-2 text-gray-500">加载中...</p>
          </div>
        </div>
        
        <!-- 侧边栏 -->
        <div class="md:w-1/3 space-y-6">
          <!-- 关于博主 -->
          <div class="bg-white rounded-xl shadow-md p-6">
            <div class="flex flex-col items-center">
              <img src="https://picsum.photos/id/64/100/100" alt="博主头像" class="w-24 h-24 rounded-full object-cover border-4 border-indigo-100">
              <h3 class="text-xl font-bold text-gray-800 mt-4">博主名称</h3>
              <p class="text-gray-600 text-center mt-2">热爱技术，分享生活的程序员。欢迎交流！</p>
              <div class="flex space-x-4 mt-4">
                <a href="#" class="text-gray-400 hover:text-indigo-600 transition-colors"><i class="fa fa-github text-xl"></i></a>
                <a href="#" class="text-gray-400 hover:text-indigo-600 transition-colors"><i class="fa fa-twitter text-xl"></i></a>
                <a href="#" class="text-gray-400 hover:text-indigo-600 transition-colors"><i class="fa fa-linkedin text-xl"></i></a>
              </div>
            </div>
          </div>
          
          <!-- 热门文章 -->
          <div class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center">
              <i class="fa fa-fire text-orange-500 mr-2"></i> 热门文章
            </h3>
            <div class="space-y-4">
              <div v-for="(article, index) in popularArticles" :key="index" class="flex gap-3">
                <div class="w-20 h-20 bg-gray-100 rounded overflow-hidden flex-shrink-0">
                  <img 
                    :src="`https://picsum.photos/id/${20 + index}/200/200`" 
                    alt="文章缩略图" 
                    class="w-full h-full object-cover hover:scale-110 transition-transform duration-300"
                  >
                </div>
                <div>
                  <h4 class="text-sm font-medium text-gray-800 line-clamp-2 hover:text-indigo-600 transition-colors cursor-pointer"
                      @click="viewArticle(article.id)">
                    {{ article.title }}
                  </h4>
                  <p class="text-xs text-gray-500 mt-1">{{ formatDate(article.created_at) }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- 文章详情模态框 -->
    <div v-if="isArticleModalOpen" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
      <div class="bg-white rounded-xl shadow-xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
        <!-- 模态框头部 -->
        <div class="p-6 border-b border-gray-100 flex justify-between items-center">
          <h2 class="text-xl font-bold text-gray-800">文章详情</h2>
          <button @click="closeArticleModal" class="text-gray-400 hover:text-gray-600 transition-colors">
            <i class="fa fa-times text-xl"></i>
          </button>
        </div>
        
        <!-- 模态框内容 -->
        <div class="flex-grow overflow-y-auto p-6">
          <div v-if="currentArticle" class="article-content">
            <h1 class="text-2xl font-bold text-gray-800 mb-4">{{ currentArticle.title }}</h1>
            <div class="flex items-center text-gray-500 text-sm mb-6">
              <span><i class="fa fa-user mr-1"></i> {{ currentArticle.author }}</span>
              <span class="mx-2">•</span>
              <span><i class="fa fa-calendar mr-1"></i> {{ formatDate(currentArticle.created_at) }}</span>
            </div>
            <div class="prose max-w-none">
              <!-- 这里应该是富文本内容，简单处理为换行显示 -->
              <p v-for="(paragraph, index) in currentArticle.content.split('\n')" :key="index" class="mb-4">
                {{ paragraph }}
              </p>
            </div>
          </div>
          
          <!-- 评论区 -->
          <div class="mt-10">
            <h3 class="text-xl font-bold text-gray-800 mb-6">评论 ({{ comments.length }})</h3>
            
            <!-- 评论输入框 -->
            <div class="mb-8">
              <div class="flex gap-3">
                <img src="https://picsum.photos/id/64/40/40" alt="Your avatar" class="w-8 h-8 rounded-full object-cover">
                <div class="flex-grow">
                  <textarea 
                    v-model="newComment.content"
                    placeholder="写下你的评论..." 
                    class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none"
                    rows="3"
                  ></textarea>
                  <div class="flex justify-between mt-2">
                    <input 
                      v-model="newComment.author"
                      type="text" 
                      placeholder="你的昵称" 
                      class="px-3 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-1 focus:ring-indigo-500 w-40"
                    >
                    <button 
                      @click="addComment()"
                      class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md transition-colors text-sm"
                      :disabled="!newComment.author || !newComment.content"
                    >
                      发表评论
                    </button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- 评论列表 -->
            <div class="space-y-6">
              <div v-for="comment in comments" :key="comment.id" class="flex gap-3">
                <img src="https://picsum.photos/id/{{ 100 + comment.id }}/40/40" alt="Comment author" class="w-8 h-8 rounded-full object-cover">
                <div class="bg-gray-50 p-4 rounded-lg w-full">
                  <div class="flex justify-between items-start">
                    <h4 class="font-medium text-gray-800">{{ comment.author }}</h4>
                    <span class="text-xs text-gray-500">{{ formatDate(comment.created_at) }}</span>
                  </div>
                  <p class="text-gray-600 mt-1">{{ comment.content }}</p>
                </div>
              </div>
              
              <div v-if="comments.length === 0" class="text-center py-8 bg-gray-50 rounded-lg">
                <p class="text-gray-500">还没有评论，快来抢沙发吧！</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 创建文章模态框 -->
    <div v-if="isCreateModalOpen" class="fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
      <div class="bg-white rounded-xl shadow-xl w-full max-w-4xl max-h-[90vh] overflow-hidden flex flex-col">
        <!-- 模态框头部 -->
        <div class="p-6 border-b border-gray-100 flex justify-between items-center">
          <h2 class="text-xl font-bold text-gray-800">发布新文章</h2>
          <button @click="isCreateModalOpen = false" class="text-gray-400 hover:text-gray-600 transition-colors">
            <i class="fa fa-times text-xl"></i>
          </button>
        </div>
        
        <!-- 模态框内容 -->
        <div class="flex-grow overflow-y-auto p-6">
          <div class="space-y-4">
            <div>
              <label for="title" class="block text-sm font-medium text-gray-700 mb-1">标题</label>
              <input 
                id="title"
                v-model="newArticle.title"
                type="text" 
                class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                placeholder="输入文章标题"
              >
            </div>
            
            <div>
              <label for="author" class="block text-sm font-medium text-gray-700 mb-1">作者</label>
              <input 
                id="author"
                v-model="newArticle.author"
                type="text" 
                class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500"
                placeholder="输入作者名称"
              >
            </div>
            
            <div>
              <label for="content" class="block text-sm font-medium text-gray-700 mb-1">内容</label>
              <textarea 
                id="content"
                v-model="newArticle.content"
                class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 resize-none min-h-[300px]"
                placeholder="输入文章内容"
              ></textarea>
            </div>
          </div>
        </div>
        
        <!-- 模态框底部 -->
        <div class="p-6 border-t border-gray-100 flex justify-end space-x-3">
          <button 
            @click="isCreateModalOpen = false"
            class="px-4 py-2 border border-gray-300 rounded-md hover:bg-gray-50 transition-colors"
          >
            取消
          </button>
          <button 
            @click="createArticle()"
            class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-md transition-colors"
            :disabled="!newArticle.title || !newArticle.content || !newArticle.author"
          >
            发布文章
          </button>
        </div>
      </div>
    </div>

    <!-- 页脚 -->
    <footer class="bg-white border-t border-gray-200 py-8">
      <div class="container mx-auto px-4">
        <div class="flex flex-col md:flex-row justify-between items-center">
          <div class="flex items-center space-x-2 mb-4 md:mb-0">
            <i class="fa fa-book text-indigo-600"></i>
            <span class="text-gray-800 font-bold">MyBlog</span>
          </div>
          <p class="text-gray-500 text-sm">© 2023 MyBlog. All rights reserved.</p>
          <div class="flex space-x-4 mt-4 md:mt-0">
            <a href="#" class="text-gray-400 hover:text-indigo-600 transition-colors"><i class="fa fa-github"></i></a>
            <a href="#" class="text-gray-400 hover:text-indigo-600 transition-colors"><i class="fa fa-twitter"></i></a>
            <a href="#" class="text-gray-400 hover:text-indigo-600 transition-colors"><i class="fa fa-linkedin"></i></a>
          </div>
        </div>
      </div>
    </footer>
  </div>
</template>

<script>
export default {
  data() {
    return {
      // 状态变量
      isScrolled: false,
      isArticleModalOpen: false,
      isCreateModalOpen: false,
      loading: false,
      searchQuery: '',
      
      // 数据变量
      articles: [],
      popularArticles: [],
      currentArticle: null,
      comments: [],
      
      // 表单数据
      newArticle: {
        title: '',
        content: '',
        author: ''
      },
      newComment: {
        author: '',
        content: ''
      }
    };
  },
  
  created() {
    // 页面加载时获取文章列表
    this.fetchArticles();
    
    // 监听滚动事件
    window.addEventListener('scroll', this.handleScroll);
  },
  
  beforeUnmount() {
    // 移除滚动监听
    window.removeEventListener('scroll', this.handleScroll);
  },
  
  methods: {
    // 处理滚动事件
    handleScroll() {
      this.isScrolled = window.scrollY > 10;
    },
    
    // 格式化日期
    formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString('zh-CN', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });
    },
    
    // API调用 - 获取文章列表
    async fetchArticles(search = '') {
      this.loading = true;
      try {
        let url = 'http://localhost:5000/api/articles';
        if (search) {
          url += `?search=${encodeURIComponent(search)}`;
        }
        
        const response = await fetch(url);
        if (!response.ok) {
          throw new Error('Failed to fetch articles');
        }
        
        this.articles = await response.json();
        // 简单处理热门文章（取前3篇）
        this.popularArticles = [...this.articles].slice(0, 3);
        
        // 为每篇文章添加评论计数
        for (const article of this.articles) {
          const commentsResponse = await fetch(`http://localhost:5000/api/articles/${article.id}/comments`);
          if (commentsResponse.ok) {
            const comments = await commentsResponse.json();
            article.commentsCount = comments.length;
          } else {
            article.commentsCount = 0;
          }
        }
      } catch (error) {
        console.error('Error fetching articles:', error);
        alert('获取文章失败，请稍后重试');
      } finally {
        this.loading = false;
      }
    },
    
    // 搜索文章
    searchArticles() {
      this.fetchArticles(this.searchQuery);
    },
    
    // 清除搜索
    clearSearch() {
      this.searchQuery = '';
      this.fetchArticles();
    },
    
    // 查看文章详情
    async viewArticle(articleId) {
      try {
        const response = await fetch(`http://localhost:5000/api/articles/${articleId}`);
        if (!response.ok) {
          throw new Error('Failed to fetch article');
        }
        
        this.currentArticle = await response.json();
        this.isArticleModalOpen = true;
        
        // 获取该文章的评论
        await this.fetchComments(articleId);
      } catch (error) {
        console.error('Error fetching article:', error);
        alert('获取文章详情失败，请稍后重试');
      }
    },
    
    // 关闭文章详情模态框
    closeArticleModal() {
      this.isArticleModalOpen = false;
      this.currentArticle = null;
      this.comments = [];
      this.newComment = { author: '', content: '' };
    },
    
    // 获取评论
    async fetchComments(articleId) {
      try {
        const response = await fetch(`http://localhost:5000/api/articles/${articleId}/comments`);
        if (!response.ok) {
          throw new Error('Failed to fetch comments');
        }
        
        this.comments = await response.json();
      } catch (error) {
        console.error('Error fetching comments:', error);
        alert('获取评论失败，请稍后重试');
      }
    },
    
    // 添加评论
    async addComment() {
      if (!this.currentArticle || !this.newComment.author || !this.newComment.content) {
        return;
      }
      
      try {
        const response = await fetch(
          `http://localhost:5000/api/articles/${this.currentArticle.id}/comments`,
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(this.newComment)
          }
        );
        
        if (!response.ok) {
          throw new Error('Failed to add comment');
        }
        
        // 重新获取评论列表
        await this.fetchComments(this.currentArticle.id);
        
        // 清空评论输入框
        this.newComment = { author: '', content: '' };
        
        // 显示成功提示
        alert('评论添加成功！');
      } catch (error) {
        console.error('Error adding comment:', error);
        alert('添加评论失败，请稍后重试');
      }
    },
    
    // 创建文章
    async createArticle() {
      if (!this.newArticle.title || !this.newArticle.content || !this.newArticle.author) {
        return;
      }
      
      try {
        const response = await fetch('http://localhost:5000/api/articles', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(this.newArticle)
        });
        
        if (!response.ok) {
          throw new Error('Failed to create article');
        }
        
        // 关闭模态框
        this.isCreateModalOpen = false;
        
        // 重新获取文章列表
        this.fetchArticles();
        
        // 清空表单
        this.newArticle = { title: '', content: '', author: '' };
        
        // 显示成功提示
        alert('文章发布成功！');
      } catch (error) {
        console.error('Error creating article:', error);
        alert('发布文章失败，请稍后重试');
      }
    }
  }
};
</script>

<style>

@import '@fortawesome/fontawesome-free/css/all.css';

/* 自定义动画 */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* 文章内容样式 */
.article-content h2 {
  font-size: 1.5rem;
  font-weight: bold;
  margin-top: 1.5rem;
  margin-bottom: 1rem;
}

.article-content p {
  margin-bottom: 1rem;
  line-height: 1.6;
}

.article-content ul, .article-content ol {
  margin-bottom: 1rem;
  padding-left: 1.5rem;
}

.article-content ul {
  list-style-type: disc;
}

.article-content ol {
  list-style-type: decimal;
}

/* 平滑滚动 */
html {
  scroll-behavior: smooth;
}
</style>
